<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tyut.mapper.DoctorProfileMapper">
<select id="list" resultMap="DoctorBasicResultMap">
    SELECT DISTINCT
    su.id as userId,
    su.username,
    su.phone,
    su.avatar_url as avatarUrl,
    su.status,
    dp.id as doctorId,
    dp.name,
    dp.specialty,
    dp.title,
    dp.introduction,
    dp.gender,
    dp.age,
    d.id as departmentId,
    d.name as departmentName
    FROM sys_user su
    LEFT JOIN doctor_profile dp ON su.id = dp.user_id
    LEFT JOIN department d ON dp.department_id = d.id
    <where>
        su.role_type = 1
        AND su.is_deleted = 0
        AND su.status = 1
        <if test="query.departmentId != null">
            AND dp.department_id = #{query.departmentId}
        </if>
        <if test="query.weekDay != null">
            AND EXISTS (
            SELECT 1 FROM doctor_schedule ds
            WHERE ds.doctor_id = su.id AND ds.week_day = #{query.weekDay}
            )
        </if>
        <if test="query.timeSlot != null and query.timeSlot != ''">
            AND EXISTS (
            SELECT 1 FROM doctor_schedule ds
            WHERE ds.doctor_id = su.id AND ds.time_slot = #{query.timeSlot}
            )
        </if>
        <if test="query.name != null and query.name != ''">
            AND dp.name LIKE CONCAT('%', #{query.name}, '%')
        </if>
        <if test="query.title != null">
            AND dp.title = #{query.title}
        </if>
    </where>
    ORDER BY su.id ASC
</select>

<!-- 添加基础ResultMap（不含排班集合） -->
<resultMap id="DoctorBasicResultMap" type="com.tyut.vo.DoctorDetailVO">
    <result property="userId" column="userId"/>
    <result property="username" column="username"/>
    <result property="phone" column="phone"/>
    <result property="avatarUrl" column="avatarUrl"/>
    <result property="status" column="status"/>
    <result property="doctorId" column="doctorId"/>
    <result property="name" column="name"/>
    <result property="specialty" column="specialty"/>
    <result property="title" column="title"/>
    <result property="introduction" column="introduction"/>
    <result property="gender" column="gender"/>
    <result property="age" column="age"/>
    <result property="departmentId" column="departmentId"/>
    <result property="departmentName" column="departmentName"/>
</resultMap>


</mapper>
